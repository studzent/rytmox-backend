# Лимиты транскрибации голосовых сообщений

## Текущие настройки лимитов

### Frontend (React Native / Expo)

**Файл:** `app/src/screens/AITeam/AITeamScreen.tsx`

- **Максимальная длительность записи:** `300 секунд` (5 минут)
  ```javascript
  maxDuration: 300
  ```

- **Предупреждение о размере:** `15 MB`
  - Показывается предупреждение в логах, но отправка разрешена

- **Блокировка отправки:** `25 MB`
  - Если размер файла > 25 MB, отправка блокируется с сообщением пользователю

- **Качество записи:** `LOW_QUALITY` preset
  - Оптимизировано для голосовых сообщений (моно, низкий битрейт)

---

### Backend - Express

**Файл:** `rytmox-backend/index.js`

- **Лимит размера JSON body:** `50 MB`
  ```javascript
  app.use(express.json({ limit: '50mb' }));
  ```

**Файл:** `rytmox-backend/routes/chat.js`

- **Лимит для роута `/chat/transcribe`:** `50 MB`
  ```javascript
  const transcribeJsonParser = express.json({ limit: '50mb' });
  ```

---

### Backend - Transcription Service

**Файл:** `rytmox-backend/services/transcriptionService.js`

- **Максимальный размер файла:** `25 MB`
  - Проверка перед отправкой в Whisper API
  - Сообщение об ошибке: "Audio file is too large (X MB). Maximum size is 25 MB."

- **Таймаут OpenAI API:** `300000 мс` (5 минут / 300 секунд)
  ```javascript
  timeout: 300000
  ```

---

### Nginx (на сервере)

**Рекомендуемые настройки для `api.rytmox.ai`:**

```nginx
server {
    # Глобальные настройки
    client_max_body_size 50M;
    client_body_timeout 300s;
    proxy_read_timeout 300s;
    proxy_connect_timeout 300s;
    proxy_send_timeout 300s;
    
    # Специфичные настройки для транскрибации
    location /chat/transcribe {
        client_max_body_size 50M;
        client_body_timeout 300s;
        proxy_read_timeout 300s;
        # ...
    }
}
```

- **client_max_body_size:** `50 MB`
- **client_body_timeout:** `300 секунд` (5 минут)
- **proxy_read_timeout:** `300 секунд` (5 минут)

---

### OpenAI Whisper API (внешний сервис)

**Официальные лимиты OpenAI (теоретический максимум):**

- **Максимальный размер файла:** `25 MB` (жесткий лимит)
- **Теоретическая максимальная длительность:** `~25 минут аудио` (зависит от битрейта)
  - ⚠️ **НО:** В нашем приложении мы ограничили до **5 минут** (300 секунд)
  - Это лимит самого Whisper API, но мы не используем его полностью
- **Модель:** `whisper-1`
- **Язык:** `ru` (явно указан для лучшей точности)
- **Temperature:** `0` (детерминированный результат)

---

## Сводная таблица лимитов

| Компонент | Параметр | Значение | Примечание |
|-----------|----------|----------|------------|
| **Frontend** | maxDuration | 300 сек (5 мин) | Максимальная длительность записи |
| **Frontend** | Предупреждение | 15 MB | Предупреждение в логах |
| **Frontend** | Блокировка | 25 MB | Блокировка отправки |
| **Backend Express** | JSON body limit | 50 MB | Глобальный лимит |
| **Backend Express** | /chat/transcribe limit | 50 MB | Лимит для роута транскрибации |
| **Backend Service** | Проверка размера | 25 MB | Проверка перед Whisper API |
| **Backend Service** | OpenAI timeout | 300 сек (5 мин) | Таймаут запроса к Whisper API |
| **Nginx** | client_max_body_size | 50 MB | Лимит размера запроса |
| **Nginx** | Таймауты | 300 сек (5 мин) | client_body_timeout, proxy_read_timeout |
| **Whisper API** | Макс. размер | 25 MB | Жесткий лимит OpenAI |
| **Whisper API** | Теор. макс. длительность | ~25 мин | Теоретический максимум (не используется) |
| **Наше приложение** | Фактический лимит | 5 мин | Ограничение в коде (maxDuration: 300) |

---

## Почему такие значения?

### 50 MB в Nginx и Express
- Base64 увеличивает размер файла на ~33%
- 25 MB оригинального файла × 1.33 = ~33 MB в base64
- 50 MB дает запас для заголовков и метаданных

### 5 минут (300 секунд) - наш лимит
- Оптимально для голосовых сообщений в чате
- Баланс между удобством и стоимостью
- Whisper API теоретически может обработать до ~25 минут, но мы ограничили до 5 минут для чата

### 25 MB - жесткий лимит
- Это лимит OpenAI Whisper API, его нельзя обойти
- При LOW_QUALITY preset 5 минут записи обычно занимают 1-5 MB

---

## Стоимость транскрибации

**Whisper API:** $0.006 за минуту

- 1 минута = $0.006
- 5 минут = $0.03
- 25 минут = $0.15

---

## Время обработки

Транскрибация занимает примерно **1/10 от длительности аудио**:

- 1 минута аудио ≈ 6 секунд обработки
- 5 минут аудио ≈ 30 секунд обработки

