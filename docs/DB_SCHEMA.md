# Схема базы данных RYTM0X

Этот документ описывает структуру базы данных проекта RYTM0X. SQL определения находятся в файле `supabase/schema.sql`.

**ВАЖНО**: Эта схема является источником истины для всех разработчиков и AI. При работе с базой данных всегда сверяйтесь с этим документом.

## Общая информация

- **База данных**: Supabase (PostgreSQL)
- **Источник SQL**: `supabase/schema.sql`
- **Принцип работы**: централизованная БД, все клиенты работают через API

## Таблицы

### users

Таблица пользователей приложения.

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | UUID | Уникальный идентификатор пользователя (первичный ключ, автогенерация) |
| `email` | TEXT | Email пользователя (уникальный, обязательное поле) |
| `password_hash` | TEXT | Хеш пароля пользователя (обязательное поле) |
| `created_at` | TIMESTAMP WITH TIME ZONE | Дата и время создания записи (автоматически) |
| `updated_at` | TIMESTAMP WITH TIME ZONE | Дата и время последнего обновления записи (автоматически обновляется) |
| `profile_data` | JSONB | Дополнительные данные профиля в формате JSON (рост, вес, цели, уровень подготовки и т.д.). По умолчанию: `{}` |

**Индексы:**
- `users_email_key` — уникальный индекс на поле `email`

**Триггеры:**
- `update_users_updated_at` — автоматически обновляет `updated_at` при изменении записи

**Использование:**
- Хранение данных пользователя
- Аутентификация через email/password
- Профильные данные в `profile_data` (гибкая структура для будущих расширений)

---

### exercises

Таблица упражнений — каталог всех доступных упражнений в системе.

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | BIGSERIAL | Уникальный идентификатор упражнения (первичный ключ, автогенерация) |
| `slug` | TEXT | Уникальный текстовый идентификатор упражнения (обязательное поле, уникальный). Используется для удобной работы с упражнениями в API и AI |
| `name_en` | TEXT | Название упражнения на английском языке (обязательное поле) |
| `name_ru` | TEXT | Название упражнения на русском языке (обязательное поле) |
| `main_muscle` | TEXT | Основная группа мышц, задействованная в упражнении (обязательное поле). Пример: `'chest'`, `'back'`, `'legs'` |
| `secondary_muscles` | TEXT[] | Массив дополнительных групп мышц, задействованных в упражнении (опционально). Пример: `['triceps', 'shoulders']` |
| `equipment` | TEXT | Необходимое оборудование (обязательное поле). Возможные значения: `'bodyweight'`, `'dumbbells'`, `'barbell'`, `'pull-up bar'` и т.д. |
| `level` | TEXT | Уровень сложности упражнения (обязательное поле). Возможные значения: `'beginner'`, `'intermediate'`, `'advanced'` |
| `instructions_en` | TEXT | Инструкции по выполнению упражнения на английском языке (опционально) |
| `instructions_ru` | TEXT | Инструкции по выполнению упражнения на русском языке (опционально) |
| `thumbnail_url` | TEXT | URL превью/миниатюры упражнения (опционально, хранится в Supabase Storage) |
| `created_at` | TIMESTAMP WITH TIME ZONE | Дата и время создания записи (автоматически, по умолчанию: now()) |

**Индексы:**
- Уникальный индекс на поле `slug`

**Использование:**
- Каталог упражнений для AI-генерации тренировок
- Справочник для форм-чека
- Фильтрация по оборудованию, группам мышц и уровню сложности
- AI работает с упражнениями через `slug` (предпочтительно) или `id`
- AI в основном использует английские поля (`name_en`, `instructions_en`) для генерации тренировок
- UI/клиенты могут показывать пользователю либо русскую, либо английскую версию в зависимости от настроек

**Связи:**
- Связана с `workout_exercises` через `exercise_id`
- Связана с `exercise_videos` через `exercise_id` (дополнительные варианты видео)

**Примечания:**
- Подробнее о стратегии заполнения каталога см. [EXERCISE_CATALOG_PLAN.md](./EXERCISE_CATALOG_PLAN.md)
- Дополнительные варианты видео (разные версии, языки, форматы) хранятся в таблице `exercise_videos`
- Подробнее о работе с медиа см. [EXERCISE_MEDIA.md](./EXERCISE_MEDIA.md)

---

### exercise_videos

Таблица дополнительных вариантов видео для упражнений. Хранит различные версии видео одного и того же упражнения (разные языки, форматы, варианты выполнения).

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | BIGSERIAL | Уникальный идентификатор записи (первичный ключ, автогенерация) |
| `exercise_id` | BIGINT | Идентификатор упражнения (внешний ключ -> `exercises.id`, ON DELETE CASCADE) |
| `variant` | TEXT | Вариант видео. Возможные значения: `'default'`, `'home'`, `'gym'`, `'no_equipment'` и т.д. |
| `language` | TEXT | Язык видео. Возможные значения: `'ru'`, `'en'` и т.д. |
| `aspect_ratio` | TEXT | Соотношение сторон видео. Возможные значения: `'9:16'` (вертикальное), `'16:9'` (горизонтальное), `'1:1'` (квадратное) |
| `video_url` | TEXT | URL видео (хранится в Supabase Storage) |
| `thumbnail_url` | TEXT | URL превью/миниатюры видео (хранится в Supabase Storage) |
| `notes` | TEXT | Дополнительные заметки к видео (опционально) |
| `created_at` | TIMESTAMP WITH TIME ZONE | Дата и время создания записи (автоматически) |

**Использование:**
- Хранение дополнительных вариантов видео для упражнений
- Поддержка разных языков и форматов
- Разные варианты выполнения (дома, в зале, без оборудования)

**Связи:**
- `exercise_videos_exercise_id_fkey` — внешний ключ на таблицу `exercises` (ON DELETE CASCADE)

**Примечания:**
- Основное видео упражнения хранится в поле `exercises.video_url`
- Эта таблица предназначена для дополнительных вариантов видео
- Клиентские приложения сами выбирают нужный вариант видео на основе `variant`, `language`, `aspect_ratio`
- Все видео хранятся в Supabase Storage, в таблице хранятся только URL
- Подробнее о работе с медиа см. [EXERCISE_MEDIA.md](./EXERCISE_MEDIA.md)

---

### workouts

Таблица тренировок пользователей.

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | UUID | Уникальный идентификатор тренировки (первичный ключ, автогенерация) |
| `user_id` | UUID | Идентификатор пользователя (внешний ключ -> `users.id`, CASCADE DELETE) |
| `name` | TEXT | Название тренировки (обязательное поле) |
| `date` | DATE | Дата проведения тренировки (обязательное поле) |
| `notes` | TEXT | Заметки к тренировке (опционально) |
| `created_at` | TIMESTAMP WITH TIME ZONE | Дата и время создания записи (автоматически) |

**Индексы:**
- `workouts_user_id_idx` — индекс для быстрого поиска тренировок по пользователю

**Связи:**
- `workouts_user_id_fkey` — внешний ключ на таблицу `users` (ON DELETE CASCADE)

**Использование:**
- Хранение информации о тренировках пользователя
- Связь с упражнениями через `workout_exercises`

---

### workout_exercises

Связующая таблица между тренировками и упражнениями. Содержит детали выполнения упражнения в рамках конкретной тренировки.

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | UUID | Уникальный идентификатор записи (первичный ключ, автогенерация) |
| `workout_id` | UUID | Идентификатор тренировки (внешний ключ -> `workouts.id`, CASCADE DELETE) |
| `exercise_id` | UUID | Идентификатор упражнения (внешний ключ -> `exercises.id`, CASCADE DELETE) |
| `sets` | INTEGER | Количество подходов (опционально) |
| `reps` | INTEGER | Количество повторений (опционально) |
| `weight` | DECIMAL(10, 2) | Вес в килограммах (опционально) |
| `rest_seconds` | INTEGER | Время отдыха между подходами в секундах (опционально) |
| `order_index` | INTEGER | Порядковый номер упражнения в тренировке (по умолчанию: 0) |

**Индексы:**
- `workout_exercises_workout_id_idx` — индекс для быстрого поиска упражнений по тренировке
- `workout_exercises_exercise_id_idx` — индекс для быстрого поиска тренировок по упражнению

**Ограничения:**
- `workout_exercises_workout_exercise_unique` — уникальность комбинации `(workout_id, exercise_id, order_index)` (позволяет одному упражнению быть в тренировке несколько раз с разным порядком)

**Связи:**
- `workout_exercises_workout_id_fkey` — внешний ключ на таблицу `workouts` (ON DELETE CASCADE)
- `workout_exercises_exercise_id_fkey` — внешний ключ на таблицу `exercises` (ON DELETE CASCADE)

**Использование:**
- Детали выполнения каждого упражнения в тренировке
- Отслеживание прогресса (вес, количество повторений)
- Порядок упражнений в тренировке

---

### ai_logs

Таблица логов всех запросов к AI сервисам. Используется для анализа использования, улучшения промптов и отладки.

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | UUID | Уникальный идентификатор записи (первичный ключ, автогенерация) |
| `user_id` | UUID | Идентификатор пользователя (внешний ключ -> `users.id`, CASCADE DELETE) |
| `request_type` | TEXT | Тип запроса. Допустимые значения: `'workout'`, `'nutrition'`, `'form_check'` (CHECK constraint) |
| `request_data` | JSONB | Данные запроса к AI в формате JSON (входные параметры, промпт и т.д.). По умолчанию: `{}` |
| `response_data` | JSONB | Данные ответа от AI в формате JSON (сгенерированная тренировка, рекомендации и т.д.). По умолчанию: `{}` |
| `created_at` | TIMESTAMP WITH TIME ZONE | Дата и время создания записи (автоматически) |

**Индексы:**
- `ai_logs_user_id_idx` — индекс для быстрого поиска логов по пользователю
- `ai_logs_request_type_idx` — индекс для поиска по типу запроса

**Связи:**
- `ai_logs_user_id_fkey` — внешний ключ на таблицу `users` (ON DELETE CASCADE)

**Использование:**
- Логирование всех AI-запросов для анализа
- Отладка и улучшение промптов
- Статистика использования AI-функций
- Аудит и мониторинг

**Типы запросов:**
- `workout` — генерация тренировки
- `nutrition` — рекомендации по питанию
- `form_check` — проверка техники выполнения упражнения

---

## Правила работы со схемой

### Общие принципы

1. **Источник истины**: SQL определения находятся в `supabase/schema.sql`. Этот документ (`DB_SCHEMA.md`) является человекочитаемым описанием.

2. **Неразрушающие изменения**: 
   - ❌ **Нельзя**: удалять таблицы, удалять колонки, изменять типы полей без миграции
   - ✅ **Можно**: добавлять новые поля и таблицы, добавлять индексы

3. **Синхронизация**: все изменения схемы должны быть отражены в обоих файлах (`supabase/schema.sql` и `docs/DB_SCHEMA.md`) перед применением в Supabase.

4. **CASCADE DELETE**: большинство связей используют `ON DELETE CASCADE`, что означает автоматическое удаление связанных записей при удалении родительской записи.

### Процесс изменения схемы

1. Обновить `supabase/schema.sql` с SQL-миграцией
2. Обновить `docs/DB_SCHEMA.md` с описанием изменений
3. Применить миграцию в Supabase
4. Протестировать изменения

### Расширение схемы

При добавлении новых полей или таблиц:

- Новые поля должны быть опциональными (NULL) или иметь значения по умолчанию
- Новые таблицы должны следовать существующим соглашениям (UUID для ID, timestamps и т.д.)
- Все внешние ключи должны иметь соответствующие индексы для производительности

## Связи между таблицами

```
users
  ├── workouts (1:N) - один пользователь может иметь много тренировок
  └── ai_logs (1:N) - один пользователь может иметь много AI-логов

workouts
  └── workout_exercises (1:N) - одна тренировка содержит много упражнений

exercises
  ├── workout_exercises (1:N) - одно упражнение может быть в разных тренировках
  └── exercise_videos (1:N) - одно упражнение может иметь несколько вариантов видео

workout_exercises
  ├── workouts (N:1) - многие записи принадлежат одной тренировке
  └── exercises (N:1) - многие записи ссылаются на одно упражнение
```

## Дополнительная информация

- Общая архитектура проекта: [RYTM0X_OVERVIEW.md](./RYTM0X_OVERVIEW.md)
- Стратегия каталога упражнений: [EXERCISE_CATALOG_PLAN.md](./EXERCISE_CATALOG_PLAN.md)
- Работа с медиа упражнений: [EXERCISE_MEDIA.md](./EXERCISE_MEDIA.md)

