# Работа с медиа упражнений RYTM0X

## Концепция

В системе RYTM0X медиа-контент для упражнений организован следующим образом:

### exercises — данные об упражнении

Таблица `exercises` содержит основную информацию об упражнении:
- Метаданные: название (на двух языках), инструкции по выполнению (на двух языках), группы мышц, оборудование, уровень сложности
- **`thumbnail_url`** — превью/миниатюра упражнения (опционально)
- Упражнение имеет два текстовых описания: `instructions_en` (английский) и `instructions_ru` (русский)
- AI в основном опирается на английские поля (`name_en`, `instructions_en`) при генерации тренировок
- UI/клиенты могут показывать пользователю либо русскую, либо английскую версию в зависимости от настроек пользователя

### exercise_videos — разные версии видео

Таблица `exercise_videos` содержит дополнительные варианты видео для одного и того же упражнения:
- Разные варианты выполнения (`variant`: `default`, `home`, `gym`, `no_equipment`)
- Разные языки (`language`: `ru`, `en`)
- Разные форматы (`aspect_ratio`: `9:16`, `16:9`, `1:1`)
- Превью/миниатюры (`thumbnail_url`)

## Примеры использования

### Как workout AI работает через slug

1. AI генерирует тренировку и выбирает упражнения по их `slug` (или `id`) из таблицы `exercises`
2. AI не работает напрямую с видео — он работает только с метаданными упражнений
3. AI возвращает клиенту список упражнений с их идентификаторами

### Как клиенты вытягивают медиа по exercise_id

1. **Превью/миниатюра:**
   ```sql
   SELECT thumbnail_url FROM exercises WHERE id = 'exercise_id';
   ```

2. **Дополнительные варианты видео:**
   ```sql
   SELECT * FROM exercise_videos 
   WHERE exercise_id = 'exercise_id' 
   AND language = 'ru' 
   AND variant = 'home';
   ```

3. **Логика выбора на клиенте:**
   - Клиент получает `exercise_id` от AI
   - Клиент запрашивает превью из `exercises.thumbnail_url` (если доступно)
   - Клиент запрашивает текстовые инструкции из `exercises.instructions_en` или `exercises.instructions_ru` в зависимости от языка пользователя
   - Клиент может запросить дополнительные варианты видео из `exercise_videos` на основе:
     - Предпочтений пользователя (язык, формат)
     - Доступного оборудования (`variant`)
     - Ориентации экрана (`aspect_ratio`)

## Правила работы с медиа

### ❌ Нельзя

- **Менять структуру таблиц** `exercises` и `exercise_videos` без миграций
- Удалять поля из существующих таблиц
- Изменять типы полей без миграций

### ✅ Можно

- **Добавлять новые поля** через SQL-модификации (ALTER TABLE)
- Добавлять новые записи в `exercise_videos`
- Обновлять URL существующих видео

### Хранение медиа

- **Все видео и изображения хранятся в Supabase Storage**
- В таблицах хранятся только **URL** на файлы в Storage
- URL имеют формат: `https://[project].supabase.co/storage/v1/object/public/[bucket]/[path]`

### Пример структуры URL

```
exercises.thumbnail_url: 
  https://xyz.supabase.co/storage/v1/object/public/exercises/push-ups-thumb.jpg

exercise_videos.video_url:
  https://xyz.supabase.co/storage/v1/object/public/exercises/push-ups-home-ru.mp4
```

## Архитектурные принципы

1. **Разделение ответственности:**
   - `exercises` = метаданные (названия, инструкции на двух языках) + превью
   - `exercise_videos` = дополнительные варианты видео

2. **Гибкость:**
   - Клиент сам выбирает нужный вариант видео
   - Backend не навязывает конкретный вариант

3. **Масштабируемость:**
   - Легко добавлять новые варианты видео без изменения структуры
   - Поддержка множества языков и форматов

4. **Производительность:**
   - Превью упражнения доступно через `exercises.thumbnail_url` (если загружено)
   - Текстовые инструкции доступны на двух языках через `exercises.instructions_en` и `exercises.instructions_ru`
   - Дополнительные варианты видео загружаются по требованию из `exercise_videos`

## Связанная документация

- Структура БД: [DB_SCHEMA.md](./DB_SCHEMA.md)
- Каталог упражнений: [EXERCISE_CATALOG_PLAN.md](./EXERCISE_CATALOG_PLAN.md)
- Общая архитектура: [RYTM0X_OVERVIEW.md](./RYTM0X_OVERVIEW.md)

